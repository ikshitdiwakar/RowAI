<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Row AI</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
    body {
      background: radial-gradient(circle at center, #0b0b0b 0%, #000000 70%);
      overflow: hidden;
      height: 100vh;
      color: white;
    }

    /* ===== THEME VARIABLES (CHANGE PER MODE) ===== */
    :root{
      --accent: 255,140,0;      /* default Jarvis orange */
      --accent2: 255,90,0;
      --hud: 255,140,0;
    }

    body.theme-chat   { --accent: 255,140,0;   --accent2: 255,90,0;   --hud: 255,140,0; }   /* orange */
    body.theme-search { --accent: 0,220,255;   --accent2: 0,150,255;  --hud: 0,220,255; }   /* cyan */
    body.theme-create { --accent: 190,90,255;  --accent2: 120,0,255;  --hud: 190,90,255; }  /* purple */
    body.theme-code   { --accent: 60,255,140;  --accent2: 0,220,80;   --hud: 60,255,140; }  /* green */
    body.theme-plan   { --accent: 80,170,255;  --accent2: 40,110,255; --hud: 80,170,255; }  /* blue */

    /* HUD grid */
    .hud-lines {
      position: absolute; inset: 0;
      background:
        linear-gradient(to right, rgba(var(--hud),0.06) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(var(--hud),0.06) 1px, transparent 1px);
      background-size: 80px 80px;
      opacity: 0.22;
      z-index: 0;
    }

    /* Particle canvas */
    #sparkCanvas { position: absolute; inset: 0; z-index: 1; pointer-events: none; }

    /* Core wrapper: CENTERED */
    .core-wrap {
      position: absolute;
      left: 50%;
      top: 42%;
      transform: translate(-50%, -50%);
      width: 520px;
      height: 520px;
      z-index: 4;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.6s ease;
    }

    /* Jarvis Core Orb */
    .jarvis-core {
      position: relative;
      width: 420px;
      height: 420px;
      border-radius: 50%;
      background:
        radial-gradient(circle,
          rgba(var(--accent),0.95) 0%,
          rgba(var(--accent2),0.25) 52%,
          rgba(var(--accent2),0.06) 82%);
      box-shadow:
        0 0 60px rgba(var(--accent),0.55),
        0 0 120px rgba(var(--accent2),0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.6s ease;
      animation: slowPulse 3s infinite ease-in-out;
    }

    /* Rotating rings */
    .jarvis-core::before {
      content: "";
      position: absolute;
      width: 85%;
      height: 85%;
      border-radius: 50%;
      border: 3px solid rgba(var(--accent),0.32);
      box-shadow: 0 0 40px rgba(var(--accent),0.18);
      animation: spinRing 10s linear infinite;
    }

    .jarvis-core::after {
      content: "";
      position: absolute;
      width: 65%;
      height: 65%;
      border-radius: 50%;
      border: 2px dashed rgba(var(--accent),0.36);
      animation: spinRingReverse 8s linear infinite;
    }

    /* Core center */
    .core-center {
      width: 92px;
      height: 92px;
      border-radius: 50%;
      background: radial-gradient(circle,
        rgba(255,255,255,0.95) 0%,
        rgba(var(--accent),0.95) 45%,
        rgba(var(--accent2),0.95) 100%);
      box-shadow: 0 0 36px rgba(var(--accent),0.85);
      animation: coreFlicker 2s infinite ease-in-out;
      z-index: 2;
    }

    /* Waveform ring */
    .wave-ring {
      position: absolute;
      width: 520px;
      height: 520px;
      border-radius: 50%;
      border: 2px solid rgba(var(--accent),0.18);
      box-shadow: 0 0 30px rgba(var(--accent),0.16);
      filter: drop-shadow(0 0 12px rgba(var(--accent),0.20));
      animation: wavePulse 2.4s infinite ease-in-out;
      z-index: 3;
      transition: 0.35s ease;
      opacity: 0.85;
    }

    .core-wrap.active .wave-ring {
      border-color: rgba(var(--accent),0.55);
      box-shadow: 0 0 55px rgba(var(--accent),0.30);
      opacity: 1;
      animation: wavePulseActive 1.2s infinite ease-in-out;
    }

    /* Contracted mode */
    .core-wrap.contracted { top: 18%; width: 260px; height: 260px; }
    .core-wrap.contracted .jarvis-core { width: 180px; height: 180px; }
    .core-wrap.contracted .wave-ring { width: 260px; height: 260px; }

    /* Vibrate */
    .core-wrap.vibrate { animation: vibrate 0.4s infinite linear; }

    /* Top bar */
    .topbar {
      position: absolute; left: 0; right: 0; top: 0;
      padding: 14px 18px;
      z-index: 8;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
    }

    .brand { display: flex; gap: 12px; align-items: center; }
    .logo {
      width: 44px; height: 44px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(var(--accent),0.95), rgba(var(--accent2),0.95));
      display: grid; place-items: center;
      box-shadow: 0 0 18px rgba(var(--accent),0.30);
      font-weight: 900; color: #120b00;
    }
    .brand .txt h1 { font-size: 18px; letter-spacing: 1px; }
    .brand .txt p { font-size: 12px; opacity: 0.65; }

    .status {
      display: flex; align-items: center; gap: 10px;
      font-size: 13px; opacity: 0.9;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: #00ff6a;
      box-shadow: 0 0 12px rgba(0,255,106,0.65);
    }

    .perf {
      display: flex; gap: 10px; align-items: center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(var(--accent),0.22);
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
    }
    .perf b { color: rgba(var(--accent),1); }
    .perf span { opacity: 0.75; }

    /* ===== SIDE HUD (NEW) ===== */
    .sidehud{
      position: absolute;
      right: 16px;
      top: 92px;
      z-index: 9;
      width: 240px;
      border-radius: 16px;
      border: 1px solid rgba(var(--accent),0.22);
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(12px);
      box-shadow: 0 0 22px rgba(var(--accent),0.12);
      padding: 12px;
      pointer-events: none;
    }
    .sidehud h3{
      font-size: 12px;
      letter-spacing: 1px;
      opacity: 0.85;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .hudrow{
      display:flex;
      justify-content: space-between;
      align-items:center;
      font-size: 13px;
      padding: 8px 8px;
      border-radius: 12px;
      border: 1px solid rgba(var(--accent),0.12);
      background: rgba(255,255,255,0.03);
      margin-bottom: 8px;
    }
    .hudrow .k{ opacity: 0.7; }
    .hudrow .v{ font-weight: 700; color: rgba(var(--accent),1); }

    /* Bottom UI */
    .container {
      position: absolute; left: 0; right: 0; bottom: 0;
      z-index: 7;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 18px;
      gap: 12px;
    }

    .chat-area {
      width: 100%;
      max-width: 1000px;
      height: 48vh;
      padding: 18px;
      border-radius: 18px;
      background: rgba(15, 15, 15, 0.65);
      border: 1px solid rgba(var(--accent),0.20);
      backdrop-filter: blur(14px);
      overflow-y: auto;
      box-shadow: 0 0 20px rgba(var(--accent),0.12);
    }

    .msg { margin: 12px 0; display: flex; flex-direction: column; gap: 6px; }
    .msg .tag { font-size: 12px; opacity: 0.7; letter-spacing: 1px; }

    .bubble {
      padding: 14px 16px;
      border-radius: 16px;
      max-width: 78%;
      line-height: 1.45;
      font-size: 15px;
      border: 1px solid rgba(var(--accent),0.22);
      background: rgba(var(--accent),0.07);
      box-shadow: 0 0 12px rgba(var(--accent),0.10);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .user .bubble {
      align-self: flex-end;
      background: rgba(120, 0, 255, 0.12);
      border: 1px solid rgba(160, 90, 255, 0.3);
      box-shadow: 0 0 12px rgba(160, 90, 255, 0.12);
    }
    .ai .bubble { align-self: flex-start; }

    .bubble pre, .bubble code {
      display: block;
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(var(--accent),0.14);
      overflow-x: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
    }

    .input-bar {
      width: 100%;
      max-width: 1000px;
      display: flex;
      gap: 10px;
      align-items: center;
      background: rgba(0,0,0,0.7);
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(var(--accent),0.26);
      backdrop-filter: blur(10px);
      box-shadow: 0 0 18px rgba(var(--accent),0.14);
    }

    input {
      flex: 1;
      padding: 12px;
      font-size: 15px;
      border-radius: 12px;
      border: none;
      outline: none;
      background: rgba(255, 255, 255, 0.06);
      color: white;
    }
    input::placeholder { color: rgba(255,255,255,0.5); }

    button {
      border: none;
      cursor: pointer;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: bold;
      transition: 0.25s ease;
      user-select: none;
    }

    #sendBtn {
      background: linear-gradient(135deg, rgba(var(--accent),0.95), rgba(var(--accent2),0.95));
      color: #120b00;
      box-shadow: 0 0 12px rgba(var(--accent),0.42);
    }
    #sendBtn:hover { transform: scale(1.06); }

    #micBtn {
      background: rgba(var(--accent),0.12);
      border: 1px solid rgba(var(--accent),0.36);
      color: white;
    }
    #micBtn:hover { transform: scale(1.06); background: rgba(var(--accent),0.20); }

    .modes { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .mode {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(var(--accent),0.10);
      border: 1px solid rgba(var(--accent),0.18);
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: 0.25s;
      user-select: none;
    }
    .mode.active {
      background: linear-gradient(135deg, rgba(var(--accent),0.95), rgba(var(--accent2),0.95));
      color: #120b00;
      font-weight: bold;
      box-shadow: 0 0 10px rgba(var(--accent),0.50);
    }

    /* Animations */
    @keyframes spinRing { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes spinRingReverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
    @keyframes slowPulse { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.04); opacity: 0.92; } }
    @keyframes coreFlicker { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.15); opacity: 0.85; } }

    @keyframes wavePulse {
      0%, 100% { transform: scale(1); filter: drop-shadow(0 0 12px rgba(var(--accent),0.20)); }
      50% { transform: scale(1.02); filter: drop-shadow(0 0 18px rgba(var(--accent),0.26)); }
    }
    @keyframes wavePulseActive {
      0%,100% { transform: scale(1); filter: drop-shadow(0 0 18px rgba(var(--accent),0.34)); }
      50% { transform: scale(1.05); filter: drop-shadow(0 0 28px rgba(var(--accent),0.45)); }
    }

    @keyframes vibrate {
      0% { transform: translate(-50%, -50%) translate(0, 0) scale(1.02); }
      25% { transform: translate(-50%, -50%) translate(1px, -1px) scale(1.04); }
      50% { transform: translate(-50%, -50%) translate(-1px, 1px) scale(1.05); }
      75% { transform: translate(-50%, -50%) translate(1px, 1px) scale(1.04); }
      100% { transform: translate(-50%, -50%) translate(0, 0) scale(1.02); }
    }

    @media(max-width: 920px) {
      .sidehud{ display:none; } /* keeps mobile clean */
    }
    @media(max-width: 820px) {
      .core-wrap { top: 38%; width: 360px; height: 360px; }
      .jarvis-core { width: 280px; height: 280px; }
      .wave-ring { width: 360px; height: 360px; }
      .core-wrap.contracted { top: 16%; width: 220px; height: 220px; }
      .core-wrap.contracted .jarvis-core { width: 150px; height: 150px; }
      .core-wrap.contracted .wave-ring { width: 220px; height: 220px; }
      .chat-area { height: 40vh; }
      .bubble { max-width: 92%; }
    }
    /* --- Subtle Background Sparkles (behind core) --- */
.bg-sparkles {
  position: absolute;
  inset: 0;
  z-index: 0;              /* behind canvas + core */
  pointer-events: none;
  opacity: 0.22;           /* very subtle */
  filter: blur(0.2px);
  background:
    radial-gradient(circle at 10% 20%, rgba(var(--accent),0.10) 0 2px, transparent 3px),
    radial-gradient(circle at 20% 80%, rgba(255,255,255,0.06) 0 1px, transparent 2px),
    radial-gradient(circle at 35% 35%, rgba(var(--accent),0.08) 0 1px, transparent 2px),
    radial-gradient(circle at 55% 15%, rgba(255,255,255,0.05) 0 1px, transparent 2px),
    radial-gradient(circle at 70% 60%, rgba(var(--accent),0.09) 0 2px, transparent 3px),
    radial-gradient(circle at 85% 25%, rgba(255,255,255,0.05) 0 1px, transparent 2px),
    radial-gradient(circle at 90% 80%, rgba(var(--accent),0.07) 0 1px, transparent 2px);
  animation: driftSparkles 14s linear infinite;
  background-size: 900px 900px;
}

@keyframes driftSparkles {
  0%   { transform: translate3d(0, 0, 0) scale(1); }
  50%  { transform: translate3d(-18px, 12px, 0) scale(1.02); }
  100% { transform: translate3d(0, 0, 0) scale(1); }
}
/* =========================
   ENERGY FOG / NEBULA LAYER
   ========================= */
.energy-fog {
  position: absolute;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  opacity: 0.28;
  mix-blend-mode: screen;
  filter: blur(60px);
  background:
    radial-gradient(circle at 30% 40%, rgba(var(--accent),0.18), transparent 45%),
    radial-gradient(circle at 70% 60%, rgba(var(--accent),0.14), transparent 50%),
    radial-gradient(circle at 50% 80%, rgba(var(--accent),0.10), transparent 55%);
  animation: fogDrift 18s ease-in-out infinite alternate;
}

/* gentle drifting movement */
@keyframes fogDrift {
  0% {
    transform: translate3d(-30px, 20px, 0) scale(1);
  }
  50% {
    transform: translate3d(20px, -10px, 0) scale(1.08);
  }
  100% {
    transform: translate3d(-10px, 30px, 0) scale(1);
  }
}
/* =========================
   BOOT OVERLAY
   ========================= */
.boot-overlay{
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: radial-gradient(circle at center, rgba(0,0,0,0.85), rgba(0,0,0,0.98));
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 800ms ease;
}

.boot-card{
  width: min(520px, 92vw);
  border-radius: 22px;
  border: 1px solid rgba(var(--accent),0.22);
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(14px);
  box-shadow: 0 0 30px rgba(var(--accent),0.14);
  padding: 22px;
}

.boot-title{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom: 16px;
}
.boot-badge{
  width: 44px; height: 44px;
  border-radius: 14px;
  display:grid; place-items:center;
  font-weight: 900;
  color: #120b00;
  background: linear-gradient(135deg, rgba(var(--accent),0.95), rgba(var(--accent2),0.95));
  box-shadow: 0 0 18px rgba(var(--accent),0.30);
}
.boot-title h2{
  font-size: 18px;
  letter-spacing: 1px;
}
.boot-title p{
  font-size: 12px;
  opacity: 0.7;
  margin-top: 2px;
}

.boot-bar{
  height: 12px;
  border-radius: 999px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(var(--accent),0.14);
  overflow: hidden;
  margin-bottom: 10px;
}
.boot-bar > div{
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, rgba(var(--accent),0.35), rgba(var(--accent),0.95));
  box-shadow: 0 0 20px rgba(var(--accent),0.35);
  border-radius: 999px;
  animation: bootFill 2.2s ease forwards;
}
@keyframes bootFill{
  0% { width: 0%; }
  60% { width: 76%; }
  100% { width: 100%; }
}

.boot-logs{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size: 12px;
  opacity: 0.8;
  line-height: 1.5;
  height: 96px;
  overflow: hidden;
  border-radius: 14px;
  padding: 12px;
  border: 1px solid rgba(var(--accent),0.12);
  background: rgba(0,0,0,0.35);
}

.boot-overlay.hide{
  opacity: 0;
  pointer-events: none;
}
#ttsBtn{
  background: rgba(var(--accent),0.12);
  border: 1px solid rgba(var(--accent),0.36);
  color: white;
}
#ttsBtn:hover{
  transform: scale(1.06);
  background: rgba(var(--accent),0.20);
}
#ttsBtn.off{
  opacity: 0.55;
  filter: grayscale(0.3);
}
.actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
  opacity:0.95;
}
.actions button{
  padding:8px 12px;
  border-radius:14px;
  border:1px solid rgba(var(--accent),0.25);
  background: rgba(255,255,255,0.06);
  color:#fff;
  cursor:pointer;
  transition: transform .15s ease, background .15s ease;
}
.actions button:hover{
  transform: translateY(-1px);
  background: rgba(var(--accent),0.15);
}
.rag-panel{
  position: fixed;
  right: 18px;
  bottom: 110px;
  width: 320px;
  padding: 14px;
  border-radius: 18px;
  background: rgba(0,0,0,0.45);
  border: 1px solid rgba(var(--accent),0.25);
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 28px rgba(0,0,0,0.35);
  z-index: 50;
}

.rag-title{
  font-weight: 700;
  margin-bottom: 10px;
  letter-spacing: 0.4px;
}

.rag-input, .rag-textarea{
  width: 100%;
  color: #fff;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 12px;
  padding: 10px;
  outline: none;
  margin-bottom: 10px;
}

.rag-textarea{
  height: 120px;
  resize: vertical;
}

.rag-actions{
  display: flex;
  gap: 10px;
}

.rag-btn{
  flex: 1;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid rgba(var(--accent),0.25);
  background: rgba(var(--accent),0.18);
  color: #fff;
  cursor: pointer;
  transition: transform .15s ease, background .15s ease;
}

.rag-btn:hover{
  transform: translateY(-1px);
  background: rgba(var(--accent),0.28);
}

.rag-btn.secondary{
  background: rgba(255,255,255,0.06);
  border-color: rgba(255,255,255,0.10);
}

.rag-status{
  margin-top: 10px;
  font-size: 12px;
  opacity: 0.85;
}

/* Mobile: hide panel (clean UI) */
@media (max-width: 640px){
  .rag-panel{ display:none; }
}
/* Floating toggle button */
.rag-toggle{
  position: fixed;
  right: 20px;
  bottom: 160px;
  width: 46px;
  height: 46px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  font-size: 18px;
  background: rgba(var(--accent),0.85);
  color: white;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  transition: transform .2s ease;
  z-index: 60;
}
.rag-toggle:hover{
  transform: scale(1.1);
}

/* Slide panel */
.rag-panel{
  position: fixed;
  right: 20px;
  bottom: 220px;
  width: 320px;
  padding: 16px;
  border-radius: 18px;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(var(--accent),0.25);
  box-shadow: 0 12px 32px rgba(0,0,0,0.45);
  transform: translateX(120%);
  transition: transform .35s ease;
  z-index: 55;
}

.rag-panel.show{
  transform: translateX(0);
}

.rag-title{
  font-weight: 700;
  margin-bottom: 10px;
}

.rag-input, .rag-textarea{
  width: 100%;
  color: #fff;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px;
  padding: 10px;
  outline: none;
  margin-bottom: 10px;
}

.rag-textarea{
  height: 120px;
  resize: vertical;
}

.rag-actions{
  display: flex;
  gap: 10px;
}

.rag-btn{
  flex: 1;
  padding: 10px;
  border-radius: 12px;
  border: 1px solid rgba(var(--accent),0.25);
  background: rgba(var(--accent),0.18);
  color: white;
  cursor: pointer;
}

.rag-btn.secondary{
  background: rgba(255,255,255,0.06);
}

.rag-status{
  margin-top: 8px;
  font-size: 12px;
  opacity: 0.8;
}

/* hide on mobile for clean UI */
@media (max-width: 640px){
  .rag-toggle,
  .rag-panel{
    display:none;
  }
}
/* 2-button floating box */
.membox{
  position: fixed;
  right: 18px;
  bottom: 150px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 80;
}
.membtn{
  padding: 10px 14px;
  border-radius: 14px;
  border: 1px solid rgba(var(--accent),0.25);
  background: rgba(var(--accent),0.16);
  color:#fff;
  cursor:pointer;
  backdrop-filter: blur(10px);
}
.membtn.secondary{
  background: rgba(255,255,255,0.06);
  border-color: rgba(255,255,255,0.12);
}

/* Panels */
.panel{
  position: fixed;
  right: 18px;
  bottom: 215px;
  width: 360px;
  max-height: 70vh;
  overflow: auto;
  border-radius: 18px;
  border: 1px solid rgba(var(--accent),0.25);
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(12px);
  box-shadow: 0 14px 36px rgba(0,0,0,0.45);
  z-index: 75;
  padding: 14px;
  transform: translateX(120%);
  transition: transform .3s ease;
}
.panel.show{ transform: translateX(0); }
.hidden{ display:none; }

.panel-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:10px;
}
.panel-title{ font-weight:800; letter-spacing:.3px; }
.xbtn{
  border:none; background:transparent; color:#fff;
  cursor:pointer; font-size:16px; opacity:.85;
}

/* Tabs */
.panel-tabs{ display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
.tab{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.12);
  background: rgba(255,255,255,0.06);
  color:#fff; cursor:pointer;
}
.tab.active{ background: rgba(var(--accent),0.22); border-color: rgba(var(--accent),0.30); }
.tabpage{ display:none; }
.tabpage.show{ display:block; }

.in,.ta{
  width:100%;
  color:#fff;
  background: rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  border-radius:12px;
  padding:10px;
  outline:none;
  margin-bottom:10px;
}
.ta{ min-height:120px; resize:vertical; }

.row{ display:flex; gap:10px; }
.btn{
  flex:1;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(var(--accent),0.25);
  background: rgba(var(--accent),0.16);
  color:#fff; cursor:pointer;
}
.btn.secondary{ background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); }
.btn.danger{ background: rgba(255,60,60,0.18); border-color: rgba(255,60,60,0.35); }

.status{ margin-top:10px; font-size:12px; opacity:.85; }
.hint{ font-size:12px; opacity:.8; margin:6px 0 10px; }

/* Drop zone */
.drop{
  border:1px dashed rgba(var(--accent),0.35);
  border-radius:16px;
  padding:16px;
  text-align:center;
  background: rgba(255,255,255,0.04);
}
.dropbig{ font-weight:800; }
.dropsmall{ opacity:.8; margin:6px 0; }

.list{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
.item{
  border:1px solid rgba(255,255,255,0.10);
  border-radius:14px;
  padding:10px;
  background: rgba(255,255,255,0.04);
}
.itemtop{ display:flex; justify-content:space-between; gap:10px; }
.itemtitle{ font-weight:700; }
.itemmeta{ font-size:11px; opacity:.75; margin-top:4px; }
.itembtn{
  border:none; cursor:pointer;
  padding:6px 10px; border-radius:10px;
  background: rgba(255,60,60,0.18);
  color:#fff;
}

/* About text */
.about p, .about li{ font-size:13px; opacity:.95; }

/* =========================
   MOBILE LAYOUT FIX
   ========================= */
@media (max-width: 640px) {

  /* hide desktop-only panels */
  .sidehud { display: none !important; }
  .hud-lines { opacity: 0.25; }

  /* make container fit */
  .container {
    width: 94vw !important;
    margin: 90px auto 16px auto !important;
    padding: 10px !important;
  }

  /* chat area visible and taller */
  .chat-area {
    height: 52vh !important;
    max-height: 52vh !important;
    overflow-y: auto !important;
  }

  /* input bar stays usable */
  .input-bar {
    position: sticky !important;
    bottom: 10px !important;
    gap: 8px !important;
  }

  #userInput {
    font-size: 16px !important; /* prevents iOS zoom */
  }

  /* modes wrap nicely */
  .modes {
    flex-wrap: wrap !important;
    gap: 8px !important;
    justify-content: center !important;
  }

  .mode {
    padding: 10px 14px !important;
    font-size: 13px !important;
  }

  /* move memory/about box to top-right */
  .membox {
    position: fixed !important;
    right: 12px !important;
    top: 90px !important;
    z-index: 9999 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
  }

  /* make panels full-screen on mobile */
  .panel {
    position: fixed !important;
    inset: 12px !important;
    width: auto !important;
    height: auto !important;
    max-height: none !important;
    z-index: 10000 !important;
    overflow: auto !important;
    border-radius: 18px !important;
  }
}
    /* =========================
   MOBILE LAYOUT (FINAL)
   ========================= */
@media (max-width: 640px){

  body { overflow: auto !important; height: auto !important; }

  .sidehud { display: none !important; }

  /* core becomes smaller so it doesn't eat the page */
  .core-wrap{
    top: 30% !important;
    width: 280px !important;
    height: 280px !important;
  }
  .jarvis-core{ width: 210px !important; height: 210px !important; }
  .wave-ring{ width: 280px !important; height: 280px !important; }

  /* chat + modes must be visible */
  .container{
    position: relative !important;
    width: 94vw !important;
    margin: 80px auto 120px auto !important;
    padding: 10px !important;
    gap: 10px !important;
  }

  .chat-area{
    display: block !important;
    height: 45vh !important;
    max-height: 45vh !important;
    overflow-y: auto !important;
  }

  .modes{
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
    justify-content: center !important;
  }

  /* input fixed bottom */
  .input-bar{
    position: fixed !important;
    left: 10px !important;
    right: 10px !important;
    bottom: 12px !important;
    z-index: 9999 !important;
  }

  #userInput{ font-size: 16px !important; }

  /* memory/about buttons visible */
  .membox{
    position: fixed !important;
    right: 12px !important;
    top: 88px !important;
    z-index: 99999 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 10px !important;
  }

  /* panels full screen */
  .panel{
    position: fixed !important;
    inset: 12px !important;
    width: auto !important;
    height: auto !important;
    max-height: none !important;
    overflow: auto !important;
    z-index: 100000 !important;
    border-radius: 18px !important;
    transform: none !important;  /* important */
  }

  .panel.show{ transform: none !important; }
  .hidden{ display:none !important; }
}
  </style>
</head>

<body class="theme-chat">
  <div class="boot-overlay" id="bootOverlay">
  <div class="boot-card">
    <div class="boot-title">
      <div class="boot-badge">R</div>
      <div>
        <h2>Row System Boot</h2>
        <p>Initializing Groq engine ‚Ä¢ Loading UI core</p>
      </div>
    </div>

    <div class="boot-bar"><div></div></div>

    <div class="boot-logs" id="bootLogs">
      [OK] Core renderer online<br>
      [OK] Voice interface standby<br>
      [OK] Context memory ready<br>
      [OK] UI theme engine loaded<br>
      [OK] Awaiting user input...
    </div>
  </div>
</div>

  <div class="hud-lines"></div>
  <div class="bg-sparkles"></div>
  <div class="energy-fog"></div>
  <canvas id="sparkCanvas"></canvas>

  <div class="topbar">
    <div class="brand">
      <div class="logo">R</div>
      <div class="txt">
        <h1>Row</h1>
        <p id="subtitleText">Jarvis-style AI Assistant</p>
      </div>
    </div>

    <div class="status">
      <div class="dot"></div>
      <div class="perf">
        <span>Status:</span> <b id="statusText">Online</b>
        <span>‚Ä¢</span>
        <span>RT:</span> <b id="rtText">‚Äî</b>
      </div>
    </div>
  </div>

  <!-- SIDE HUD -->
  <div class="sidehud">
    <h3>Row HUD</h3>
    <div class="hudrow"><div class="k">Mode</div><div class="v" id="hudMode">Chat</div></div>
    <div class="hudrow"><div class="k">Context</div><div class="v" id="hudContext">ON</div></div>
    <div class="hudrow"><div class="k">Memory</div><div class="v" id="hudMem">‚Äî</div></div>
    <div class="hudrow"><div class="k">Model</div><div class="v" id="hudModel">‚Äî</div></div>
  </div>
  <!-- Center Core -->
  <div class="core-wrap" id="coreWrap">
    <div class="wave-ring"></div>
    <div class="jarvis-core">
      <div class="core-center"></div>
    </div>
  </div>

  <div class="container">
    <div class="chat-area" id="chatBox">
      <div class="msg ai">
        <div class="tag">Row</div>
        <div class="bubble">
          Hello, I am <b>Row</b>.<br>
          Speak or type. I can <b>Chat, Search, Create, Code, and Plan</b>.
        </div>
      </div>
    </div>

    <div class="input-bar">
  <button id="micBtn">üé§</button>
  <button id="ttsBtn" title="Toggle voice">üîä</button>
  <input type="text" id="userInput" placeholder="Type to Row..." />
  <button id="sendBtn">‚û§</button>
</div>


    <div class="modes">
      <div class="mode active">Chat</div>
      <div class="mode">Search</div>
      <div class="mode">Create</div>
      <div class="mode">Code</div>
      <div class="mode">Plan</div>
    </div>
  </div>
<!-- Memory Control Box (2 buttons) -->
<div class="membox">
  <button id="memHubBtn" class="membtn">üìö Memory</button>
  <button id="memAboutBtn" class="membtn secondary">‚ÑπÔ∏è About</button>
</div>

<!-- Memory Hub Panel (hidden by default) -->
<div id="memHub" class="panel hidden">
  <div class="panel-head">
    <div class="panel-title">Row Memory Hub</div>
    <button id="memClose" class="xbtn">‚úï</button>
  </div>

  <div class="panel-tabs">
    <button class="tab active" data-tab="add">Add Text</button>
    <button class="tab" data-tab="pdf">Upload PDF</button>
    <button class="tab" data-tab="view">Viewer</button>
    <button class="tab" data-tab="export">Export</button>
  </div>

  <!-- TAB: Add Text -->
  <div class="tabpage show" id="tab-add">
    <input id="ragTitle" class="in" placeholder="Title (optional)" />
    <textarea id="ragContent" class="ta" placeholder="Paste notes / docs / code snippets..."></textarea>
    <div class="row">
      <button id="ragSaveBtn" class="btn">Save</button>
      <button id="ragClearBtn" class="btn secondary">Clear</button>
    </div>
    <div id="ragStatus" class="status">Ready</div>
  </div>

  <!-- TAB: Upload PDF -->
  <div class="tabpage" id="tab-pdf">
    <div id="dropZone" class="drop">
      <div class="dropbig">Drop PDF here</div>
      <div class="dropsmall">or</div>
      <input id="pdfPick" type="file" accept="application/pdf" />
    </div>
    <div class="hint">Tip: works best with text-based PDFs (not scanned photos).</div>
    <div id="pdfStatus" class="status">Waiting</div>
  </div>

  <!-- TAB: Viewer -->
  <div class="tabpage" id="tab-view">
    <input id="viewSearch" class="in" placeholder="Search your memory (e.g., Flask CORS)" />
    <div class="row">
      <button id="viewRefresh" class="btn">Refresh</button>
      <button id="viewClearAll" class="btn danger">Clear All</button>
    </div>
    <div id="memList" class="list"></div>
    <div id="viewStatus" class="status">Ready</div>
  </div>

  <!-- TAB: Export -->
  <div class="tabpage" id="tab-export">
    <div class="hint">Export downloads your saved memory as a JSON file.</div>
    <button id="exportBtn" class="btn">Download Export</button>
    <div id="exportStatus" class="status">Ready</div>
  </div>
</div>

<!-- About Panel (hidden by default) -->
<div id="memAbout" class="panel hidden">
  <div class="panel-head">
    <div class="panel-title">About Memory Hub</div>
    <button id="aboutClose" class="xbtn">‚úï</button>
  </div>

  <div class="about">
    <p><b>What this does:</b> It lets you store your own notes, PDFs, project docs, and snippets so Row can answer using <b>your</b> content.</p>

    <p><b>When to use:</b></p>
    <ul>
      <li>When you want Row to remember your project details</li>
      <li>When you have notes/PDFs and want instant ‚Äúsearch my docs‚Äù answers</li>
      <li>When building a public assistant but with custom knowledge</li>
    </ul>

    <p><b>How to use:</b></p>
    <ol>
      <li>Click <b>üìö Memory</b></li>
      <li>Add text or upload a PDF</li>
      <li>In chat, ask: <b>‚ÄúSearch my docs: ‚Ä¶‚Äù</b></li>
    </ol>

    <p><b>Advantages:</b></p>
    <ul>
      <li>Row becomes personalized + smarter for your content</li>
      <li>Faster answers (no re-explaining every time)</li>
      <li>Great for startup demos: ‚ÄúAI trained on our docs‚Äù</li>
      <li>Export/clear makes it safe + controllable</li>
    </ul>
  </div>
</div>

  <script>
/* =========================
   ROW UI CORE SCRIPT (COMPILED + SAFE)
   - Auto mode switch by text
   - Action buttons
   - Voice upgrades + TTS toggle
   - Boot overlay
   - Sounds
   - Fog + sparks canvas + core ring reactions
   - Uses backend: /api/chat (Groq + Memory + RAG + Auto-Mode)
   ========================= */

/* ---------- DOM ---------- */
const chatBox = document.getElementById("chatBox");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");
const micBtn = document.getElementById("micBtn");
const coreWrap = document.getElementById("coreWrap");

const statusText = document.getElementById("statusText");
const rtText = document.getElementById("rtText");

const hudMode = document.getElementById("hudMode");
const hudContext = document.getElementById("hudContext");
const hudMem = document.getElementById("hudMem");
const hudModel = document.getElementById("hudModel");

const subtitleText = document.getElementById("subtitleText");
const bootOverlay = document.getElementById("bootOverlay");
const bootLogs = document.getElementById("bootLogs");

const fogEl = document.querySelector(".energy-fog");
const sparkCanvas = document.getElementById("sparkCanvas");

const modeButtons = document.querySelectorAll(".mode");

/* ---------- SAFE HELPERS ---------- */
const $ = (id) => document.getElementById(id);
function safeText(el, text){ if (el) el.textContent = text; }
function safeHTML(el, html){ if (el) el.innerHTML = html; }

/* =====================
   RAG PANEL (SAFE)
   ===================== */
const ragToggleBtn = $("ragToggleBtn");
const ragPanel = $("ragPanel");

if (ragToggleBtn && ragPanel){
  ragToggleBtn.addEventListener("click", ()=>{
    ragPanel.classList.toggle("show");
  });
}

const ragTitle = $("ragTitle");
const ragContent = $("ragContent");
const ragSaveBtn = $("ragSaveBtn");
const ragClearBtn = $("ragClearBtn");
const ragStatus = $("ragStatus");

function setRagStatus(msg){
  safeText(ragStatus, msg);
}

if (ragSaveBtn){
  ragSaveBtn.addEventListener("click", async ()=>{
    const title = (ragTitle?.value || "").trim() || "Row Doc";
    const content = (ragContent?.value || "").trim();

    if(!content){
      setRagStatus("‚ö†Ô∏è Add content first.");
      return;
    }

    setRagStatus("Saving...");

    try{
      const res = await fetch("/api/rag/add", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ title, content, source:"ui" })
      });

      const data = await res.json();

      if(data.ok){
        setRagStatus("‚úÖ Saved!");
        if (ragContent) ragContent.value = "";
        if(typeof burstSparks==="function") burstSparks(14,2);
      } else {
        setRagStatus("‚ùå Failed: " + (data.error || "unknown"));
      }
    }catch(e){
      setRagStatus("‚ùå Connection error");
      console.log(e);
    }
  });
}

if (ragClearBtn){
  ragClearBtn.addEventListener("click", ()=>{
    if (ragTitle) ragTitle.value = "";
    if (ragContent) ragContent.value = "";
    setRagStatus("Cleared");
  });
}

/* Optional voice UI */
const ttsBtn = $("ttsBtn");
const voiceSelect = $("voiceSelect");
const voiceRate = $("voiceRate");

/* ---------- STATE ---------- */
let currentMode = "Chat";
const SESSION_ID = "row-session";
let lastAIReply = "";

/* ---------- SUBTITLE MAP ---------- */
const subtitleMap = {
  "Chat":   "Conversational ‚Ä¢ Context-aware ‚Ä¢ Fast",
  "Search": "Research mode ‚Ä¢ Bullet summaries",
  "Create": "Creative studio ‚Ä¢ Ideas ‚Ä¢ Content",
  "Code":   "Code-only focus ‚Ä¢ Clean output",
  "Plan":   "Roadmap mode ‚Ä¢ Steps & Timeline",
  "Auto":   "Auto mode ‚Ä¢ Row selects best mode"
};

function setSubtitle(mode){
  if (!subtitleText) return;
  subtitleText.textContent = subtitleMap[mode] || "Jarvis-style AI Assistant";
}

/* ---------- THEME MAP ---------- */
const themeMap = {
  "Chat": "theme-chat",
  "Search": "theme-search",
  "Create": "theme-create",
  "Code": "theme-code",
  "Plan": "theme-plan",
  "Auto": "theme-chat"
};

function applyTheme(mode){
  document.body.classList.remove("theme-chat","theme-search","theme-create","theme-code","theme-plan");
  document.body.classList.add(themeMap[mode] || "theme-chat");
}

/* =========================
   SOUND FX (NO FILES)
   ========================= */
let audioCtx = null;
function ensureAudio(){
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === "suspended") audioCtx.resume();
}
function beep(freq=440, dur=0.06, type="sine", gain=0.05){
  try{
    ensureAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + dur);
  }catch(e){}
}
function sfxClick(){ beep(520, 0.04, "triangle", 0.035); }
function sfxSend(){ beep(880,0.05,"sine",0.045); setTimeout(()=>beep(660,0.05,"sine",0.04),60); }
function sfxMode(){ beep(700,0.05,"square",0.03); }
function sfxError(){ beep(220,0.10,"sawtooth",0.06); }

/* =========================
   CORE ANIMATIONS
   ========================= */
function setActive(on){
  if (!coreWrap) return;
  coreWrap.classList.toggle("active", on);
  if (fogEl){
    fogEl.style.opacity = on ? "0.45" : "0.28";
  }
}
function contractCore(){ coreWrap?.classList.add("contracted"); }
function expandCore(){ coreWrap?.classList.remove("contracted"); }
function vibrateCore(){
  if (!coreWrap) return;
  coreWrap.classList.add("vibrate");
  setTimeout(()=>coreWrap.classList.remove("vibrate"),1200);
}

/* ---------- STATUS ---------- */
function setStatus(text){ safeText(statusText, text); }
function setRT(text){ safeText(rtText, text); }

/* ---------- SAFE HTML ---------- */
function escapeHtml(str){
  return String(str || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* ---------- MESSAGE RENDER ---------- */
function addMessage(sender, text){
  if (!chatBox) return null;

  const msgDiv = document.createElement("div");
  msgDiv.classList.add("msg", sender);

  const tag = document.createElement("div");
  tag.classList.add("tag");
  tag.innerText = sender === "user" ? "You" : "Row";

  const bubble = document.createElement("div");
  bubble.classList.add("bubble");

  const formatted = String(text || "")
    .replace(/```([\s\S]*?)```/g, (m, code) => `<pre><code>${escapeHtml(code)}</code></pre>`)
    .replace(/\n/g,"<br>");

  bubble.innerHTML = formatted;

  msgDiv.appendChild(tag);
  msgDiv.appendChild(bubble);

  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
  return msgDiv;
}

/* =========================
   STRICT MODE GUARDS
   ========================= */
function looksLikeCode(t){
  if (/```[\s\S]*```/.test(t)) return true;
  return /(def |class |import |#include|public class|console\.log\(|function |<html|print\(|System\.out\.println\()/i.test(t);
}
function looksLikeBullets(t){ return /(^|\n)\s*(- |\u2022 )/m.test(t); }
function looksLikePlan(t){ return /(^|\n)\s*(1\.|2\.|3\.|4\.)/m.test(t); }

function modeMismatchMessage(mode){
  const msg = {
    "Code":  "I‚Äôm in <b>Code Mode</b> ‚Äî I‚Äôll reply with <b>code only</b>. Please re-send your request.",
    "Search":"I‚Äôm in <b>Search Mode</b> ‚Äî I‚Äôll reply in <b>bullet points</b>. Please re-send your query.",
    "Plan":  "I‚Äôm in <b>Plan Mode</b> ‚Äî I‚Äôll reply in <b>structured steps</b>. Please re-send the task."
  };
  return msg[mode] || "Please re-send your request.";
}

/* =========================
   AUTO-MODE SWITCH BY USER TEXT
   ========================= */
function autoDetectMode(text){
  const t = (text || "").toLowerCase();
  const rules = [
    { mode: "Code",   re: /\b(change|switch|set|go)\s*(the\s*)?mode\s*(to)?\s*code\b|\bcode\s*mode\b/ },
    { mode: "Search", re: /\b(change|switch|set|go)\s*(the\s*)?mode\s*(to)?\s*search\b|\bsearch\s*mode\b/ },
    { mode: "Plan",   re: /\b(change|switch|set|go)\s*(the\s*)?mode\s*(to)?\s*plan\b|\bplan\s*mode\b/ },
    { mode: "Create", re: /\b(change|switch|set|go)\s*(the\s*)?mode\s*(to)?\s*create\b|\bcreate\s*mode\b/ },
    { mode: "Chat",   re: /\b(change|switch|set|go)\s*(the\s*)?mode\s*(to)?\s*chat\b|\bchat\s*mode\b/ },
    { mode: "Auto",   re: /\b(change|switch|set|go)\s*(the\s*)?mode\s*(to)?\s*auto\b|\bauto\s*mode\b/ }
  ];
  for (const r of rules){
    if (r.re.test(t)) return r.mode;
  }
  return null;
}

function setMode(mode){
  if (!mode) return;
  currentMode = mode;

  modeButtons.forEach(b => {
    b.classList.toggle("active", b.innerText.trim() === mode);
  });

  safeText(hudMode, mode);
  safeText(hudContext, "ON");

  applyTheme(mode);
  setSubtitle(mode);

  sfxMode();
  vibrateCore();
  if(typeof burstSparks==="function") burstSparks(12, 2.0);
}

/* =========================
   VOICE (TTS)
   ========================= */
let ttsEnabled = true;
let selectedVoiceName = null;
let ttsRate = 1;

try {
  const savedT = localStorage.getItem("ROW_TTS");
  if (savedT === "off") ttsEnabled = false;
  const savedV = localStorage.getItem("ROW_VOICE");
  if (savedV) selectedVoiceName = savedV;
  const savedR = localStorage.getItem("ROW_RATE");
  if (savedR) ttsRate = parseFloat(savedR) || 1;
} catch(e){}

function updateTtsUI(){
  if (!ttsBtn) return;
  ttsBtn.classList.toggle("off", !ttsEnabled);
  ttsBtn.textContent = ttsEnabled ? "üîä" : "üîá";
}

function loadVoices(){
  if (!voiceSelect || !window.speechSynthesis) return;
  const voices = speechSynthesis.getVoices();
  voiceSelect.innerHTML = "";
  voices.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(opt);
  });
  if (selectedVoiceName) voiceSelect.value = selectedVoiceName;
}
if (window.speechSynthesis){
  window.speechSynthesis.onvoiceschanged = loadVoices;
  loadVoices();
}

voiceSelect?.addEventListener("change", ()=>{
  selectedVoiceName = voiceSelect.value;
  try { localStorage.setItem("ROW_VOICE", selectedVoiceName); } catch(e){}
});

if (voiceRate){
  voiceRate.value = String(ttsRate);
  voiceRate.addEventListener("input", ()=>{
    ttsRate = parseFloat(voiceRate.value) || 1;
    try { localStorage.setItem("ROW_RATE", String(ttsRate)); } catch(e){}
  });
}

if (ttsBtn){
  updateTtsUI();
  ttsBtn.addEventListener("click", ()=>{
    sfxClick();
    ttsEnabled = !ttsEnabled;
    try { localStorage.setItem("ROW_TTS", ttsEnabled ? "on" : "off"); } catch(e){}
    if (!ttsEnabled && window.speechSynthesis) window.speechSynthesis.cancel();
    updateTtsUI();
    addMessage("ai", ttsEnabled ? "üîä Voice output enabled." : "üîá Voice output disabled.");
  });
}

function speakText(text){
  if (!ttsEnabled) return;
  const synth = window.speechSynthesis;
  if (!synth) return;
  if (!text || text.length > 900) return;

  synth.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = ttsRate || 1;
  u.pitch = 1;
  u.lang = "en-US";

  const voices = synth.getVoices();
  if (selectedVoiceName){
    const v = voices.find(x => x.name === selectedVoiceName);
    if (v) u.voice = v;
  }
  synth.speak(u);
}

/* =========================
   ACTION BUTTONS
   ========================= */
function addActionButtons(parentMsgDiv){
  if (!parentMsgDiv) return;
  const actions = document.createElement("div");
  actions.className = "actions";

  const btns = [
    ["Summarize", "Summarize the last answer in 5 bullet points."],
    ["Shorter", "Make the last answer 50% shorter, keep key points."],
    ["Explain", "Explain the last answer in simpler words, with an example."],
    ["Plan", "Turn the last answer into a step-by-step plan."],
    ["Code", "Convert the last answer into code. Code only. Add: # Respectfully, Row"],
    ["Image Prompt", "Make a premium image-generation prompt from the last request + last answer, include size + style + negative prompt."]
  ];

  btns.forEach(([label, prompt])=>{
    const b = document.createElement("button");
    b.type = "button";
    b.textContent = label;
    b.addEventListener("click", ()=>{
      sfxClick();
      if (!lastAIReply) return;
      const followup = `${prompt}\n\nLAST ANSWER:\n${lastAIReply}`;
      sendMessage(followup);
    });
    actions.appendChild(b);
  });

  parentMsgDiv.appendChild(actions);
}

/* =========================
   SEND MESSAGE
   ========================= */
async function sendMessage(message){
  if (!message) return;
  addMessage("user", message);

  const detected = autoDetectMode(message);
  if (detected){
    setMode(detected);
    addMessage("ai", `‚úÖ Switched to <b>${detected}</b> mode.`);
  }

  contractCore();
  setActive(true);
  vibrateCore();
  setStatus("Processing");
  setRT("‚Äî");

  if(typeof burstSparks==="function") burstSparks(26, 3.0);

  const loadingMsg = addMessage("ai","<i>Row is processing...</i>");
  const t0 = performance.now();

  try{
    const res = await fetch("/api/chat",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        message,
        mode: currentMode,
        session_id: SESSION_ID
      })
    });

    const data = await res.json().catch(()=>({}));
    const ms = Math.round(performance.now() - t0);

    if (loadingMsg) loadingMsg.remove();

    if(!res.ok){
      addMessage("ai","‚ö†Ô∏è Backend Error: " + (data.error || ("HTTP " + res.status)));
      sfxError();
      setStatus("Error");
      setRT(ms+"ms");
      setActive(false);
      expandCore();
      return;
    }

    const reply = data.reply || "";
    const aiDiv = addMessage("ai", reply);

    lastAIReply = reply;
    addActionButtons(aiDiv);

    if (hudModel && data.model_used) hudModel.textContent = data.model_used;
    if (hudMem && data.memory_count != null) hudMem.textContent = data.memory_count + " msgs";

    if (data.mode && data.mode !== currentMode && currentMode === "Auto"){
      if (hudMode) hudMode.textContent = "Auto ‚Üí " + data.mode;
    }

    let ok = true;
    if(currentMode==="Code") ok = looksLikeCode(reply);
    if(currentMode==="Search") ok = looksLikeBullets(reply) || looksLikePlan(reply);
    if(currentMode==="Plan") ok = looksLikePlan(reply);

    if(!ok){
      addMessage("ai", modeMismatchMessage(currentMode));
    } else {
      if (currentMode !== "Code") speakText(reply);
    }

    setStatus("Online");
    setRT(ms+"ms");

  }catch(err){
    addMessage("ai","‚ö†Ô∏è Error connecting to backend.");
    sfxError();
    setStatus("Disconnected");
    console.log(err);
  }

  setActive(false);
  expandCore();
}

/* ---------- BUTTON EVENTS ---------- */
sendBtn?.addEventListener("click", ()=>{
  sfxSend();
  const msg = (userInput?.value || "").trim();
  if(!msg) return;
  userInput.value = "";
  sendMessage(msg);
});

userInput?.addEventListener("keypress",(e)=>{
  if(e.key==="Enter") sendBtn?.click();
});

userInput?.addEventListener("input", ()=>{
  if ((userInput.value || "").trim().length > 0) contractCore();
  else expandCore();
});

/* ---------- MODE SWITCH (manual tabs) ---------- */
modeButtons.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const mode = btn.innerText.trim();
    setMode(mode);
    addMessage("ai", `Mode switched to <b>${mode}</b>.`);
  });
});

/* =========================
   VOICE RECOGNITION
   ========================= */
let recognition;
if("webkitSpeechRecognition" in window){
  recognition = new webkitSpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang="en-US";

  recognition.onstart = ()=>{
    setStatus("Listening");
    setActive(true);
    contractCore();
    vibrateCore();
    if(typeof burstSparks==="function") burstSparks(16, 2.5);
    addMessage("ai","<i>üéôÔ∏è Listening...</i>");
  };

  recognition.onresult=(e)=>{
    const text = e.results[0][0].transcript;
    sendMessage(text);
  };

  recognition.onerror=()=>{
    addMessage("ai","‚ö†Ô∏è Voice recognition error.");
    sfxError();
    setStatus("Online");
    setActive(false);
    expandCore();
  };

  recognition.onend=()=>{
    setStatus("Online");
    setActive(false);
    expandCore();
  };
}

micBtn?.addEventListener("click", ()=>{
  sfxClick();
  if(!recognition){
    addMessage("ai","‚ö†Ô∏è Voice recognition not supported in this browser.");
    return;
  }
  recognition.start();
});

/* ==========================
   PARTICLE SPARKS (CANVAS)
   ========================== */
let ctx = null;
const sparks = [];

function resizeCanvas(){
  if (!sparkCanvas) return;
  sparkCanvas.width = window.innerWidth;
  sparkCanvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);

function getCoreCenter(){
  if (!coreWrap) return {x: window.innerWidth/2, y: window.innerHeight/2, r: 200};
  const rect = coreWrap.getBoundingClientRect();
  return { x: rect.left + rect.width/2, y: rect.top + rect.height/2, r: Math.min(rect.width, rect.height)/2 };
}

function accentRGBA(alpha){
  const c = getComputedStyle(document.body).getPropertyValue("--accent").trim();
  const safe = c || "0, 255, 255";
  return `rgba(${safe}, ${alpha})`;
}

function spawnSpark(intensity=1){
  if (!sparkCanvas) return;
  const c = getCoreCenter();
  const a = Math.random() * Math.PI * 2;
  const radius = c.r * (0.78 + Math.random() * 0.22);

  sparks.push({
    x: c.x + Math.cos(a) * radius,
    y: c.y + Math.sin(a) * radius,
    vx: (Math.random()-0.5) * (0.9*intensity),
    vy: (Math.random()-0.5) * (0.9*intensity),
    life: 40 + Math.random()*40,
    size: 1 + Math.random()*2.2,
    alpha: 0.9
  });
}

function burstSparks(count=20, intensity=2.5){
  for (let i=0;i<count;i++) spawnSpark(intensity);
}

function animateSparks(){
  if (!sparkCanvas) return;
  if (!ctx) ctx = sparkCanvas.getContext("2d");
  if (!ctx) return;

  ctx.clearRect(0,0,sparkCanvas.width,sparkCanvas.height);

  const active = coreWrap?.classList.contains("active");
  const contracted = coreWrap?.classList.contains("contracted");

  const baseSpawn = active ? 6 : 2;
  const intensity = active ? 2.2 : 1.0;
  const count = contracted ? baseSpawn + 2 : baseSpawn;

  for (let i=0;i<count;i++) spawnSpark(intensity);

  for (let i=sparks.length-1;i>=0;i--){
    const s = sparks[i];
    s.x += s.vx;
    s.y += s.vy;
    s.life -= 1;
    s.alpha *= 0.985;

    ctx.beginPath();
    ctx.fillStyle = accentRGBA(Math.max(0, s.alpha) * (active ? 1 : 0.75));
    ctx.shadowBlur = active ? 18 : 10;
    ctx.shadowColor = accentRGBA(0.85);
    ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
    ctx.fill();

    if (s.life <= 0 || s.alpha < 0.05) sparks.splice(i,1);
  }

  requestAnimationFrame(animateSparks);
}

/* =========================
   BOOT SEQUENCE
   ========================= */
function bootSequence(){
  if(!bootOverlay) return;

  const lines = [
    "[OK] Core renderer online",
    "[OK] Voice interface standby",
    "[OK] Context memory ready",
    "[OK] UI theme engine loaded",
    "[OK] Tools online (RAG + Auto)",
    "[OK] Ready."
  ];

  let i=0;
  const t=setInterval(()=>{
    safeHTML(bootLogs, lines.slice(0,i+1).join("<br>"));
    i++;
    if(i>=lines.length){
      clearInterval(t);
      setTimeout(()=>{
        bootOverlay.classList.add("hide");
        setTimeout(()=>bootOverlay.remove(),800);
      },400);
    }
  },250);
}

/* =========================
   INIT
   ========================= */
function init(){
  safeText(hudMode, currentMode);
  safeText(hudContext, "ON");
  setSubtitle(currentMode);
  applyTheme(currentMode);

  resizeCanvas();
  animateSparks();
  bootSequence();

  setStatus("Online");
  setRT("‚Äî");
}

window.addEventListener("load", init);
// ============================
// MEMORY HUB + ABOUT (WORKING)
// ============================
const memHubBtn = document.getElementById("memHubBtn");
const memAboutBtn = document.getElementById("memAboutBtn");
const memHub = document.getElementById("memHub");
const memAbout = document.getElementById("memAbout");
const memClose = document.getElementById("memClose");
const aboutClose = document.getElementById("aboutClose");

function openPanel(panel){
  if(!panel) return;
  panel.classList.remove("hidden");
  requestAnimationFrame(()=>panel.classList.add("show"));
}

function closePanel(panel){
  if(!panel) return;
  panel.classList.remove("show");
  setTimeout(()=>panel.classList.add("hidden"), 250);
}

memHubBtn?.addEventListener("click", ()=>{
  closePanel(memAbout);
  openPanel(memHub);
});

memAboutBtn?.addEventListener("click", ()=>{
  closePanel(memHub);
  openPanel(memAbout);
});

memClose?.addEventListener("click", ()=> closePanel(memHub));
aboutClose?.addEventListener("click", ()=> closePanel(memAbout));

/* Tabs switching */
const tabs = document.querySelectorAll("#memHub .tab");
tabs.forEach(t=>{
  t.addEventListener("click", ()=>{
    tabs.forEach(x=>x.classList.remove("active"));
    t.classList.add("active");

    const name = t.dataset.tab;
    document.querySelectorAll("#memHub .tabpage").forEach(p=>p.classList.remove("show"));
    document.getElementById("tab-"+name)?.classList.add("show");
  });
});
   

</script>
</body>
</html>
